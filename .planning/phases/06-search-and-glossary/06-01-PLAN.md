---
phase: 06-search-and-glossary
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - eleventy.config.js
  - src/_includes/layouts/article.njk
  - src/_includes/partials/header.njk
  - src/search/index.njk
  - src/css/components.css
autonomous: true

must_haves:
  truths:
    - "Running `npm run build` produces a `_site/pagefind/` directory containing pagefind-ui.js, pagefind-ui.css, and index files"
    - "The search page at /search/ renders a Pagefind UI search box that returns relevant articles when a query is typed"
    - "Search results show article title, excerpt text, and relevance ranking"
    - "Only article body content is indexed (sidebar, header, footer, breadcrumbs excluded from search results)"
    - "Header navigation includes links to both Search and Glossary pages"
  artifacts:
    - path: "src/search/index.njk"
      provides: "Dedicated search page with Pagefind UI"
      contains: "PagefindUI"
    - path: "eleventy.config.js"
      provides: "Pagefind post-build integration via eleventy.after event"
      contains: "pagefind"
    - path: "src/_includes/layouts/article.njk"
      provides: "data-pagefind-body attribute on article content wrapper"
      contains: "data-pagefind-body"
    - path: "src/_includes/partials/header.njk"
      provides: "Navigation links to Search and Glossary"
      contains: "search"
  key_links:
    - from: "eleventy.config.js"
      to: "_site/"
      via: "eleventy.after event runs pagefind CLI to generate _site/pagefind/ index"
      pattern: "execSync.*pagefind"
    - from: "src/search/index.njk"
      to: "_site/pagefind/"
      via: "Script tags load pagefind-ui.js and pagefind-ui.css from /pagefind/"
      pattern: "pagefind-ui"
    - from: "src/_includes/layouts/article.njk"
      to: "_site/pagefind/"
      via: "data-pagefind-body scopes what Pagefind indexes"
      pattern: "data-pagefind-body"
---

<objective>
Install Pagefind, integrate it into the Eleventy build process, create a dedicated search page, scope indexing to article content, theme the search UI to match the site design, and add Search and Glossary links to the header navigation.

Purpose: Enables users to find any concept across all 35 articles through full-text search, satisfying requirements SRCH-01 through SRCH-03.
Output: Working search page at /search/ with Pagefind UI, build-time index generation, and updated header navigation.
</objective>

<execution_context>
@/Users/ivan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ivan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-search-and-glossary/06-RESEARCH.md
@eleventy.config.js
@package.json
@src/_includes/layouts/base.njk
@src/_includes/layouts/article.njk
@src/_includes/partials/header.njk
@src/css/variables.css
@src/css/components.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Pagefind and integrate into Eleventy build</name>
  <files>
    package.json
    eleventy.config.js
    src/_includes/layouts/article.njk
  </files>
  <action>
    1. Install Pagefind as a dev dependency:
    ```bash
    npm install --save-dev pagefind
    ```

    2. In `eleventy.config.js`, add the `execSync` import at the top of the file alongside the existing imports:
    ```js
    import { execSync } from "node:child_process";
    ```

    3. Inside the default export function, add the `eleventy.after` event handler. Place it right after the existing `eleventy.before` event handler (which resets citation/sidenote counters):
    ```js
    // Run Pagefind indexer after each build
    eleventyConfig.on("eleventy.after", () => {
      execSync(`npx pagefind --site _site`, {
        encoding: "utf-8",
        stdio: "inherit",
      });
    });
    ```

    4. In `src/_includes/layouts/article.njk`, add the `data-pagefind-body` attribute to the `article-body` div. Change this line:
    ```html
    <div class="article-body">
    ```
    to:
    ```html
    <div class="article-body" data-pagefind-body>
    ```

    This scopes Pagefind indexing to article body content only. Pages without `data-pagefind-body` (homepage, search page, glossary page) are excluded from the index, which is the desired behavior.
  </action>
  <verify>
    - `npm ls pagefind` shows installed version
    - `grep "pagefind" eleventy.config.js` shows the eleventy.after event handler
    - `grep "data-pagefind-body" src/_includes/layouts/article.njk` shows the attribute on the article-body div
    - Run `npm run build` and verify `_site/pagefind/` directory exists with pagefind-ui.js, pagefind-ui.css, and index files
  </verify>
  <done>Pagefind installed as devDependency, build hook generates search index in _site/pagefind/, and only article body content is indexed.</done>
</task>

<task type="auto">
  <name>Task 2: Create search page, theme Pagefind UI, and update header navigation</name>
  <files>
    src/search/index.njk
    src/css/components.css
    src/_includes/partials/header.njk
  </files>
  <action>
    1. Create `src/search/index.njk` with the following content:
    ```html
    ---
    title: Search
    layout: layouts/base.njk
    ---
    <div class="search-page">
      <h1>Search Articles</h1>
      <p>Search across all mechanistic interpretability articles.</p>
      <div id="search"></div>
    </div>

    <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
    <script src="/pagefind/pagefind-ui.js"></script>
    <script>
      window.addEventListener('DOMContentLoaded', function() {
        new PagefindUI({
          element: "#search",
          showSubResults: true,
          showImages: false,
          baseUrl: "/learn-mech-interp/"
        });
      });
    </script>
    ```

    Key details:
    - The `<link href>` and `<script src>` paths are plain absolute paths. `EleventyHtmlBasePlugin` automatically transforms them to include the pathPrefix in the built HTML.
    - The `baseUrl` in the JavaScript string is NOT transformed by the plugin, so it must be hardcoded to `"/learn-mech-interp/"`.
    - `showSubResults: true` shows sub-headings within results for easier navigation.
    - `showImages: false` since article images are diagrams, not thumbnails.

    2. Append Pagefind UI theming CSS to the end of `src/css/components.css`. Add this block:
    ```css
    /* Pagefind search UI theming */
    .pagefind-ui {
      --pagefind-ui-scale: 0.9;
      --pagefind-ui-primary: var(--color-link, #004276);
      --pagefind-ui-text: var(--color-text, rgba(0, 0, 0, 0.87));
      --pagefind-ui-background: var(--color-background, #ffffff);
      --pagefind-ui-border: var(--color-border, rgba(0, 0, 0, 0.1));
      --pagefind-ui-tag: var(--color-background-subtle, rgba(0, 0, 0, 0.02));
      --pagefind-ui-border-width: 1px;
      --pagefind-ui-border-radius: var(--radius-md, 4px);
      --pagefind-ui-font: var(--font-body);
    }

    .search-page {
      max-width: var(--content-width-wide);
      margin: 0 auto;
      padding: var(--spacing-xl) var(--container-padding);
    }

    .search-page h1 {
      margin-bottom: var(--spacing-sm);
    }

    .search-page > p {
      color: var(--color-text-secondary);
      margin-bottom: var(--spacing-xl);
    }
    ```

    3. Update `src/_includes/partials/header.njk` to add Search and Glossary navigation links. Replace the entire `<ul class="nav-links">` block with:
    ```html
    <ul class="nav-links">
      <li><a href="/topics/">Topics</a></li>
      <li><a href="/glossary/">Glossary</a></li>
      <li><a href="/search/">Search</a></li>
    </ul>
    ```

    The Glossary link is added now even though the glossary page will be created in Plan 02. The link will temporarily 404 until Plan 02 completes, but adding both nav links at once avoids touching header.njk twice.
  </action>
  <verify>
    - `cat src/search/index.njk` shows the search page template with PagefindUI initialization
    - `grep "pagefind-ui" src/css/components.css` shows the theming CSS
    - `grep "glossary" src/_includes/partials/header.njk` shows both Glossary and Search links
    - Run `npm run build` and verify:
      - `_site/search/index.html` exists and contains the Pagefind UI script
      - The built HTML has transformed paths (e.g., `/learn-mech-interp/pagefind/pagefind-ui.js`)
      - `_site/pagefind/pagefind-ui.js` exists (search index was generated)
  </verify>
  <done>Search page renders at /search/ with themed Pagefind UI. Header navigation includes links to Topics, Glossary, and Search.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `_site/pagefind/` directory contains pagefind-ui.js, pagefind-ui.css, and index files
3. `_site/search/index.html` exists with PagefindUI constructor
4. `grep "data-pagefind-body" _site/topics/attention-mechanism/index.html` shows the attribute is present in built article HTML
5. Header navigation in any built page contains links to /search/ and /glossary/
6. Pagefind CSS variables in components.css reference the site's design tokens
7. No regressions in existing article rendering (KaTeX, citations, sidenotes, figures)
</verification>

<success_criteria>
- Build completes successfully with Pagefind indexing 35 articles
- Search page at /search/ has a functioning search input with themed UI
- Only article body content appears in search results (no sidebar/nav text)
- Search results display article title and excerpt
- Header navigation shows Topics, Glossary, and Search links
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-and-glossary/06-01-SUMMARY.md`
</output>
