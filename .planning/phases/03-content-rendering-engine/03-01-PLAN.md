---
phase: 03-content-rendering-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eleventy.config.js
  - package.json
  - src/_includes/layouts/base.njk
  - src/css/katex-overrides.css
  - src/css/prism-theme.css
  - src/topics/test/index.md
autonomous: true

must_haves:
  truths:
    - "Inline math ($...$) renders as formatted equations in the browser without client-side JS"
    - "Display math ($$...$$) renders as centered block equations without overflowing on mobile"
    - "Python/PyTorch code blocks render with syntax-colored keywords, strings, and comments"
    - "Images in markdown render wrapped in <figure> with <figcaption> elements"
  artifacts:
    - path: "eleventy.config.js"
      provides: "markdown-it configured with KaTeX and figure plugins, syntax highlight plugin registered"
      contains: "@mdit/plugin-katex"
    - path: "src/css/katex-overrides.css"
      provides: "Mobile overflow fixes for KaTeX display math"
      contains: "overflow-x: auto"
    - path: "src/css/prism-theme.css"
      provides: "Code block color theme matching site design"
      contains: "token"
    - path: "src/_includes/layouts/base.njk"
      provides: "KaTeX CSS and Prism theme CSS linked in head"
      contains: "katex"
  key_links:
    - from: "eleventy.config.js"
      to: "markdown-it"
      via: "setLibrary with katex and figure plugins"
      pattern: "setLibrary.*md"
    - from: "src/_includes/layouts/base.njk"
      to: "KaTeX CSS"
      via: "stylesheet link in head"
      pattern: "katex.*css"
---

<objective>
Set up build-time rendering for math equations, syntax-highlighted code blocks, and figures with captions by installing and configuring the standard Eleventy plugins identified in research.

Purpose: These are the foundational content types for MI educational articles. Math notation is used throughout (attention formulas, vector operations), code examples show PyTorch implementations, and diagrams need proper figure markup. All rendering happens at build time with zero client-side JS.

Output: A working Eleventy config with KaTeX math, PrismJS code highlighting, and figure/figcaption support, verified via the test article.
</objective>

<execution_context>
@/Users/ivan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ivan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-rendering-engine/03-RESEARCH.md
@eleventy.config.js
@src/_includes/layouts/base.njk
@src/css/variables.css
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install plugins and configure Eleventy for math, code, and figures</name>
  <files>
    package.json
    eleventy.config.js
  </files>
  <action>
    1. Install npm packages:
       ```bash
       npm install @mdit/plugin-katex katex @11ty/eleventy-plugin-syntaxhighlight @mdit/plugin-figure
       ```

    2. Update `eleventy.config.js`:
       - Import `markdownIt` from "markdown-it"
       - Import `{ katex }` from "@mdit/plugin-katex"
       - Import `{ figure }` from "@mdit/plugin-figure"
       - Import `syntaxHighlight` from "@11ty/eleventy-plugin-syntaxhighlight"
       - Add `eleventyConfig.addPlugin(syntaxHighlight)` AFTER the existing EleventyHtmlBasePlugin
       - Create markdown-it instance: `const md = markdownIt({ html: true })`
       - Chain `.use(katex, { output: "htmlAndMathml", throwOnError: false, errorColor: "#cc0000" })`
       - Chain `.use(figure)`
       - Call `eleventyConfig.setLibrary("md", md)` BEFORE the return statement
       - Keep all existing config (passthrough copy, dir settings, pathPrefix, etc.) unchanged

    IMPORTANT: Call `setLibrary` first, then `addPlugin(syntaxHighlight)`. The syntax highlight plugin operates at Eleventy's template layer, not markdown-it directly, so both work alongside each other. Keep `html: true` in markdown-it options so that raw HTML in markdown files (like `<details>`) passes through.
  </action>
  <verify>
    Run `npm run build` and confirm it completes without errors.
    Check that `_site/topics/test/index.html` exists.
  </verify>
  <done>
    eleventy.config.js has markdown-it configured with KaTeX and figure plugins, plus the syntax highlight plugin registered. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add KaTeX CSS, Prism theme CSS, and KaTeX overflow fixes</name>
  <files>
    src/_includes/layouts/base.njk
    src/css/katex-overrides.css
    src/css/prism-theme.css
  </files>
  <action>
    1. Create `src/css/katex-overrides.css` with mobile overflow fixes:
       - `.katex-display`: `overflow-x: auto; overflow-y: hidden; padding: 0.25rem 0; -webkit-overflow-scrolling: touch;`
       - `.katex`: `font-size: 1.1em;` (slightly larger than body for readability)
       - Mobile media query at max-width 767px: `.katex-display > .katex { max-width: 100%; }`

    2. Create `src/css/prism-theme.css` -- a light theme that matches the site's academic design:
       - Use the site's CSS variables where possible (--font-mono, --color-background-code, --color-text, etc.)
       - Style `code[class*="language-"]` and `pre[class*="language-"]` with the mono font stack, --color-background-code background
       - Token colors should be subtle and academic (not neon):
         - Comments: rgba(0,0,0,0.4) italic
         - Keywords/builtins: var(--color-link) (#004276)
         - Strings: #22863a (green)
         - Numbers: #6f42c1 (purple)
         - Functions: #005cc5 (blue)
         - Operators/punctuation: rgba(0,0,0,0.6)
       - Add `border-radius: var(--radius-md)` and appropriate padding to `pre` elements
       - Add `overflow-x: auto` to `pre` for horizontal scrolling on long lines

    3. Update `src/_includes/layouts/base.njk` `<head>` section -- add three new stylesheet links AFTER the existing CSS links:
       ```html
       <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css">
       <link rel="stylesheet" href="/css/katex-overrides.css">
       <link rel="stylesheet" href="/css/prism-theme.css">
       ```
       Note: Use the latest stable KaTeX CSS version available on CDN. Keep existing CSS links unchanged.

    4. Update `eleventyConfig.addPassthroughCopy` if needed -- the existing `"src/css"` passthrough should cover the new CSS files automatically since they are in the same directory.
  </action>
  <verify>
    Run `npm run build`.
    Inspect `_site/index.html` and confirm:
    - The `<head>` contains links to katex.min.css, katex-overrides.css, and prism-theme.css
    - The new CSS files exist in `_site/css/`
  </verify>
  <done>
    KaTeX CSS loaded from CDN, overflow fixes in place, and a custom Prism theme matching the site's academic design is created and linked.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update test article to demonstrate math, code, and figures</name>
  <files>
    src/topics/test/index.md
  </files>
  <action>
    Replace the test article content with a comprehensive demo of all content types added in this plan. Keep the existing front matter (title, description) but update the description. The article should include:

    1. **Inline math**: Text with inline expressions like "the attention score $\alpha_{ij}$" and "softmax over $d_k$ dimensions"

    2. **Display math**: A centered block equation, e.g., the attention formula:
       ```
       $$
       \text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V
       $$
       ```

    3. **Code block**: A Python/PyTorch code snippet with syntax highlighting:
       ````
       ```python
       import torch
       import torch.nn.functional as F

       def attention(Q, K, V):
           """Scaled dot-product attention."""
           d_k = Q.size(-1)
           scores = torch.matmul(Q, K.transpose(-2, -1)) / d_k ** 0.5
           weights = F.softmax(scores, dim=-1)
           return torch.matmul(weights, V)
       ```
       ````

    4. **Figure**: An image with caption text using the figure plugin syntax:
       ```
       ![Attention pattern visualization](/images/placeholder.png "Figure 1: Attention weights for an example input sequence")
       ```
       Note: The image won't load (no actual image file), but the HTML structure should have `<figure>` and `<figcaption>`.

    5. Brief explanatory text between each section so the page reads naturally.

    Update the title to "Content Rendering Test" and description to "Demonstrates math, code highlighting, figures, citations, margin notes, and collapsible prompts."
  </action>
  <verify>
    Run `npm run build`.
    Inspect `_site/topics/test/index.html`:
    - Contains KaTeX-rendered HTML (look for `class="katex"` elements)
    - Contains syntax-highlighted code (look for `class="token"` spans inside `<pre>`)
    - Contains `<figure>` and `<figcaption>` elements wrapping the image
    - No raw `$...$` or `$$...$$` delimiters visible in the HTML output
  </verify>
  <done>
    Test article renders inline math, display math, syntax-highlighted Python code, and a figure with caption. Build completes without errors and output HTML contains rendered (not raw) content.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `_site/topics/test/index.html` contains:
   - `class="katex"` elements (math rendered at build time)
   - `class="token"` spans inside `<pre>` (syntax highlighting)
   - `<figure>` and `<figcaption>` elements
   - No raw LaTeX delimiters (`$`, `$$`)
3. `_site/index.html` `<head>` includes links to katex.min.css, katex-overrides.css, and prism-theme.css
4. No client-side KaTeX JS loaded (no `<script>` tags for KaTeX)
</verification>

<success_criteria>
- Build-time KaTeX renders both inline and display math to HTML+MathML
- PrismJS highlights Python/PyTorch code at build time with academic-themed colors
- Figure plugin wraps images in semantic `<figure>`/`<figcaption>` markup
- Mobile overflow handling prevents equations from breaking page layout
- Zero client-side JavaScript required for any content rendering
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-rendering-engine/03-01-SUMMARY.md`
</output>
