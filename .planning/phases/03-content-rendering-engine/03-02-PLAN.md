---
phase: 03-content-rendering-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - eleventy.config.js
  - src/_data/references.json
  - src/css/components.css
  - src/css/layout.css
  - src/topics/test/index.md
autonomous: true

must_haves:
  truths:
    - "Numbered inline citations link to papers and show full details (title, authors, year, venue) on hover"
    - "Citations fall back to tap-to-expand on mobile screens"
    - "Margin notes appear in the right margin on wide screens (1400px+)"
    - "Margin notes collapse to expandable inline notes on narrow screens"
    - "Collapsible prompts render as expandable blocks readers can open and close"
  artifacts:
    - path: "src/_data/references.json"
      provides: "Structured citation data for inline references"
      contains: "elhage2022toy"
    - path: "eleventy.config.js"
      provides: "cite, sidenote, and marginnote shortcodes"
      contains: "addShortcode"
    - path: "src/css/components.css"
      provides: "Citation tooltip, sidenote, and details/summary styles"
      contains: "citation-tooltip"
    - path: "src/css/layout.css"
      provides: "Grid column 3 for margin notes at 1400px+"
      contains: "grid-column: 3"
  key_links:
    - from: "eleventy.config.js (cite shortcode)"
      to: "src/_data/references.json"
      via: "this.ctx.references lookup"
      pattern: "ctx.*references"
    - from: "src/css/components.css (citation-tooltip)"
      to: "eleventy.config.js (cite shortcode HTML)"
      via: "CSS class names matching shortcode output"
      pattern: "citation-tooltip"
    - from: "src/css/layout.css (grid-column: 3)"
      to: "eleventy.config.js (sidenote shortcode HTML)"
      via: "CSS class names matching shortcode output"
      pattern: "sidenote"
---

<objective>
Add the three custom content capabilities: (1) numbered citations with hover tooltips from JSON data, (2) Tufte-style margin notes/sidenotes using CSS-only responsive collapse, and (3) collapsible "pause and think" prompts using native `<details>`/`<summary>`.

Purpose: MI articles reference dozens of papers -- readers need hover-accessible citation details. Supplementary context belongs in margin notes that do not interrupt reading flow. Self-check prompts help learners pause and reflect. Together these complete the content rendering engine.

Output: Three new Eleventy shortcodes (cite, sidenote, marginnote), a references.json data file, CSS for tooltips/sidenotes/collapsibles, and the test article demonstrating all content types.
</objective>

<execution_context>
@/Users/ivan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ivan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-rendering-engine/03-RESEARCH.md
@.planning/phases/03-content-rendering-engine/03-01-SUMMARY.md
@eleventy.config.js
@src/css/components.css
@src/css/layout.css
@src/css/variables.css
@src/topics/test/index.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create citation data and add cite shortcode</name>
  <files>
    src/_data/references.json
    eleventy.config.js
  </files>
  <action>
    1. Create `src/_data/references.json` with 3-5 sample citations from the MI course. Include entries for well-known MI papers. Each entry keyed by a short identifier (e.g., "elhage2022toy") with fields: title, authors, year, venue, url. Example entries:
       - elhage2022toy: "Toy Models of Superposition" (Anthropic, 2022)
       - olsson2022context: "In-context Learning and Induction Heads" (Anthropic, 2022)
       - elhage2021mathematical: "A Mathematical Framework for Transformer Circuits" (Anthropic, 2021)
       - bricken2023monosemanticity: "Towards Monosemanticity" (Anthropic, 2023)
       - conmy2023ioi: "Towards Automated Circuit Discovery for Mechanistic Interpretability" (NeurIPS, 2023)

    2. Add an `eleventy.before` event handler in `eleventy.config.js` to reset shortcode counters before each build. This prevents stale counter values during `--serve` mode:
       ```js
       eleventyConfig.on("eleventy.before", () => {
         citationCounter = {};
         sidenoteCounter = {};
         marginCounter = {};
       });
       ```
       Declare `let citationCounter = {}; let sidenoteCounter = {}; let marginCounter = {};` at module scope (outside the export function, or inside it but before the shortcode definitions).

    3. Add `cite` shortcode to `eleventy.config.js`:
       - Takes a `key` parameter (string matching a key in references.json)
       - Accesses `this.ctx.references` to get the data (Eleventy auto-loads _data/references.json)
       - Maintains a per-page citation counter (keyed by `this.page.url`)
       - Returns HTML: a `<span class="citation" tabindex="0" role="doc-noteref">` containing:
         - An `<a>` with class "citation-number", href to ref.url, target="_blank", rel="noopener", displaying `[N]`
         - A `<span class="citation-tooltip" role="tooltip">` with the paper title (bold), authors, and venue+year (italic)
       - If the key is not found in references, return `<span class="citation-error">[??]</span>`

    Usage in markdown: `{% cite "elhage2022toy" %}`
  </action>
  <verify>
    Run `npm run build`. Confirm no errors.
    Check that `_site/_data/` or the build output correctly includes references data (Eleventy processes it internally, not copied to _site).
  </verify>
  <done>
    references.json exists with 3-5 MI paper entries. The cite shortcode produces numbered citations with tooltip HTML. Counter resets on each build.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sidenote/marginnote shortcodes and all CSS</name>
  <files>
    eleventy.config.js
    src/css/components.css
    src/css/layout.css
  </files>
  <action>
    1. Add `sidenote` shortcode to `eleventy.config.js`:
       - Takes a `content` parameter (string)
       - Maintains per-page counter (keyed by `this.page.url`)
       - Returns HTML using the Tufte CSS checkbox-hack pattern:
         - `<label for="sn-N" class="sidenote-toggle sidenote-number"></label>`
         - `<input type="checkbox" id="sn-N" class="sidenote-toggle-input"/>`
         - `<span class="sidenote">CONTENT</span>`
       - Counter auto-increments per page

    2. Add `marginnote` shortcode to `eleventy.config.js`:
       - Same pattern as sidenote but without the number:
         - `<label for="mn-N" class="sidenote-toggle marginnote-indicator">&#8853;</label>`
         - `<input type="checkbox" id="mn-N" class="sidenote-toggle-input"/>`
         - `<span class="marginnote">CONTENT</span>`

    Usage: `{% sidenote "Supplementary info here." %}` and `{% marginnote "Optional context." %}`

    3. Add citation CSS to `src/css/components.css` (append new section):
       - `.citation`: position relative, display inline
       - `.citation-number`: no text-decoration, color var(--color-link), font-weight 600
       - `.citation-tooltip`: display none, position absolute, bottom 100%, left 50%, transform translateX(-50%), background var(--color-text), color var(--color-background), padding using spacing vars, border-radius var(--radius-md), font-size var(--font-size-small), line-height 1.4, width max-content, max-width 300px, z-index 10, pointer-events none
       - `.citation:hover .citation-tooltip, .citation:focus-within .citation-tooltip`: display block
       - `.citation-error`: color #cc0000, font-weight 600
       - Mobile media query (max-width 767px): citation-tooltip becomes static position, no transform, display none, background var(--color-background-subtle), color var(--color-text), show on focus-within

    4. Add sidenote/marginnote CSS to `src/css/components.css` (append new section):
       - Sidenote counter: `.sidenote-number { counter-increment: sidenote-counter; }` with ::after showing counter value in superscript
       - `.sidenote::before`: counter value in superscript
       - Desktop (default): `.sidenote, .marginnote` -- float right, clear right, margin-right -60%, width 50%, font-size var(--font-size-small), line-height 1.3
       - Hide toggle controls on desktop: `.sidenote-toggle-input { display: none; }`, `label.sidenote-toggle:not(.sidenote-number) { display: none; }`
       - Mobile (max-width 1399px): `.sidenote, .marginnote { display: none; }`, show toggle, on checked show sidenote as block with float none, full width, background var(--color-background-subtle), padding, border-radius
       - `.marginnote-indicator`: cursor pointer, color var(--color-link)

    5. Add details/summary CSS to `src/css/components.css` (append new section):
       - `.pause-and-think`: border 1px solid var(--color-border), border-radius var(--radius-md), padding var(--spacing-md), margin var(--spacing-lg) 0, background var(--color-background-subtle)
       - `.pause-and-think summary`: cursor pointer, font-weight 600, color var(--color-link)
       - `.pause-and-think[open] summary`: margin-bottom var(--spacing-md), border-bottom 1px solid var(--color-border), padding-bottom var(--spacing-sm)

    6. Update `src/css/layout.css` -- in the existing 1400px+ media query, activate margin notes in grid column 3:
       - Add `.article-body` with `position: relative;` (needed for sidenote positioning within the grid)
       - Add `.sidenote, .marginnote` styles that use grid-column 3 approach OR use the existing float-based approach (float right with negative margin is simpler and works within the existing grid). The float approach is recommended since sidenotes are inline elements within `.article-body` which is already in grid-column 2 -- the negative margin pulls them into the right margin area.
       - Keep the existing grid structure unchanged. The sidenotes use float+negative-margin within the content column, which extends them into the right margin space provided by the grid.
  </action>
  <verify>
    Run `npm run build`. Confirm no errors.
    Inspect the CSS files to confirm new sections are present and well-formed.
  </verify>
  <done>
    Sidenote and marginnote shortcodes produce Tufte-style HTML. Citation tooltips show on hover (desktop) and focus (mobile). Details/summary has styled collapsible appearance. Margin notes positioned for wide screens.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update test article with citations, sidenotes, and collapsible prompts</name>
  <files>
    src/topics/test/index.md
  </files>
  <action>
    Extend the test article (which already has math, code, and figure demos from Plan 01) to add:

    1. **Citations**: Add 2-3 inline citations using the shortcode:
       ```
       {% cite "elhage2022toy" %}
       {% cite "olsson2022context" %}
       ```
       Weave them naturally into explanatory text, e.g., "Superposition occurs when models represent more features than dimensions {% cite 'elhage2022toy' %}."

    2. **Sidenotes**: Add 1-2 sidenotes using the shortcode:
       ```
       {% sidenote "This is analogous to compressed sensing in signal processing." %}
       ```
       Place them inline within paragraph text where supplementary context makes sense.

    3. **Margin notes**: Add 1 margin note (unnumbered):
       ```
       {% marginnote "See also: the Johnson-Lindenstrauss lemma for related dimensionality results." %}
       ```

    4. **Collapsible prompt**: Add a "Pause and think" block using native HTML:
       ```html
       <details class="pause-and-think">
       <summary>Pause and think: Why might a model use superposition?</summary>

       Consider what happens when the number of features exceeds the number of dimensions in the residual stream...

       </details>
       ```
       IMPORTANT: Leave a blank line after `<summary>` and before `</details>` so markdown-it processes the inner content as Markdown.

    The test article should now demonstrate ALL six content types: math, code, figures, citations, sidenotes, and collapsible prompts.
  </action>
  <verify>
    Run `npm run build`. Confirm no errors.
    Inspect `_site/topics/test/index.html`:
    - Contains `class="citation"` spans with `class="citation-tooltip"` children
    - Contains `class="citation-number"` links with `[1]`, `[2]` etc. text
    - Contains `class="sidenote"` spans with `class="sidenote-toggle-input"` checkboxes
    - Contains `<details class="pause-and-think">` with `<summary>` elements
    - All six content types render correctly in a single article
  </verify>
  <done>
    Test article demonstrates all six content types (math, code, figures, citations, sidenotes/margin notes, collapsible prompts). Build succeeds. HTML output contains proper markup for each content type.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `_site/topics/test/index.html` contains all six content types:
   - KaTeX-rendered math (class="katex")
   - Syntax-highlighted code (class="token" spans)
   - Figure with figcaption
   - Numbered citations with tooltip spans
   - Sidenote/marginnote with checkbox toggles
   - Details/summary collapsible blocks
3. Citation tooltips appear on hover in desktop browser
4. Sidenotes visible in margin at 1400px+ viewport width
5. Sidenotes collapse to expandable toggles below 1400px
6. Collapsible prompts open/close on click
7. No client-side JavaScript required for any functionality
</verification>

<success_criteria>
- Citations render as numbered [N] links pointing to paper URLs, with hover tooltips showing full reference details
- On mobile, citation details expand on tap/focus instead of hover
- Margin notes display in the right margin on wide (1400px+) screens
- Below 1400px, margin notes collapse and expand via checkbox toggle
- "Pause and think" prompts use native `<details>`/`<summary>` and can be expanded/collapsed
- All content types work together in a single article without conflicts
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-rendering-engine/03-02-SUMMARY.md`
</output>
