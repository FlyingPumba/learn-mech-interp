---
phase: 07-polish-accessibility
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/_includes/layouts/base.njk
  - src/_includes/layouts/article.njk
  - src/_includes/partials/header.njk
  - src/js/theme-toggle.js
  - eleventy.config.js
autonomous: false

must_haves:
  truths:
    - "Dark mode activates automatically via prefers-color-scheme when no manual preference is stored, and toggling the button switches between light and dark with the preference persisted in localStorage"
    - "No flash of unstyled content (FOUC) occurs when loading a page with a stored dark mode preference"
    - "A skip-to-content link appears on Tab as the first focusable element and jumps to the main content area"
    - "Each article displays a reading time estimate (e.g., '12 min read') near the title in the article header"
    - "KaTeX math, code blocks, and diagrams display correctly in dark mode"
  artifacts:
    - path: "src/js/theme-toggle.js"
      provides: "Dark mode toggle logic with localStorage persistence"
      min_lines: 15
    - path: "src/_includes/layouts/base.njk"
      provides: "FOUC prevention inline script, skip-to-content link, theme-toggle.js script tag, main element with id"
      contains: "data-theme"
    - path: "src/_includes/layouts/article.njk"
      provides: "Reading time display in article header"
      contains: "readingTime"
    - path: "src/_includes/partials/header.njk"
      provides: "Dark mode toggle button in header navigation"
      contains: "theme-toggle"
    - path: "eleventy.config.js"
      provides: "readingTime filter for word count estimation"
      contains: "readingTime"
  key_links:
    - from: "src/_includes/layouts/base.njk"
      to: "src/js/theme-toggle.js"
      via: "Script tag loading toggle logic, plus inline FOUC script in head"
      pattern: "theme-toggle"
    - from: "src/_includes/layouts/article.njk"
      to: "eleventy.config.js"
      via: "readingTime Nunjucks filter applied to content"
      pattern: "readingTime"
    - from: "src/_includes/layouts/base.njk"
      to: "src/css/components.css"
      via: "skip-link class on anchor element targeting main-content id"
      pattern: "skip-link.*main-content"
---

<objective>
Wire up the dark mode toggle (JS + button + FOUC prevention), add the skip-to-content accessibility link, enhance the base template with proper main element ID, and add a reading time estimate to article pages via an Eleventy filter.

Purpose: Plan 01 created the CSS variable infrastructure. This plan activates it by adding the toggle mechanism, template wiring, and the remaining polish features (skip-link, reading time).
Output: Fully functional dark mode with toggle button, accessible keyboard navigation with skip-link, and reading time on every article.
</objective>

<execution_context>
@/Users/ivan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ivan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-accessibility/07-RESEARCH.md
@.planning/phases/07-polish-accessibility/07-01-SUMMARY.md

Key existing files:
@src/_includes/layouts/base.njk
@src/_includes/layouts/article.njk
@src/_includes/partials/header.njk
@eleventy.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme toggle JS, add FOUC script and skip-link to base template, add toggle button to header</name>
  <files>src/js/theme-toggle.js, src/_includes/layouts/base.njk, src/_includes/partials/header.njk</files>
  <action>
**Create src/js/theme-toggle.js** -- a two-state toggle (light/dark) that respects system preference before first interaction:

```javascript
(function() {
  var toggle = document.querySelector('.theme-toggle');
  if (!toggle) return;

  function getEffectiveTheme() {
    var saved = localStorage.getItem('theme');
    if (saved === 'dark' || saved === 'light') return saved;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function apply(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    updateIcon(theme);
  }

  function updateIcon(theme) {
    toggle.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
    // Show sun icon in dark mode (to indicate clicking switches to light), moon in light mode
    var lightIcon = toggle.querySelector('.theme-icon-light');
    var darkIcon = toggle.querySelector('.theme-icon-dark');
    if (lightIcon && darkIcon) {
      lightIcon.style.display = theme === 'dark' ? 'block' : 'none';
      darkIcon.style.display = theme === 'dark' ? 'none' : 'block';
    }
  }

  // Initialize icon state
  updateIcon(getEffectiveTheme());

  toggle.addEventListener('click', function() {
    var current = getEffectiveTheme();
    apply(current === 'dark' ? 'light' : 'dark');
  });
})();
```

**Modify src/_includes/layouts/base.njk:**

1. Add FOUC prevention inline script in `<head>` BEFORE any `<link>` stylesheet tags (right after `<meta name="description">`):
```html
<script>
(function() {
  var t = localStorage.getItem('theme');
  if (t === 'dark' || t === 'light') {
    document.documentElement.setAttribute('data-theme', t);
  }
})();
</script>
```

2. Add skip-to-content link as the FIRST child of `<body>`:
```html
<a href="#main-content" class="skip-link">Skip to content</a>
```

3. Change `<main>` to `<main id="main-content">` so the skip link has a target.

4. Add the theme-toggle.js script tag BEFORE the closing `</body>` tag, alongside the existing sidebar-toggle.js:
```html
<script src="/js/theme-toggle.js"></script>
```

**Modify src/_includes/partials/header.njk:**

Add the dark mode toggle button inside `.site-nav`, between the `.nav-links` `<ul>` and the `.sidebar-toggle` button:

```html
<button class="theme-toggle" aria-label="Switch to dark mode" type="button">
  <svg class="theme-icon-light" aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"/>
    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
  </svg>
  <svg class="theme-icon-dark" aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
  </svg>
</button>
```

Also add CSS for the toggle button to components.css. Wait -- components.css is not in this plan's files_modified. Instead, add these styles as a `<style>` block? No -- better approach: add the toggle button styles directly in components.css. Add `src/css/components.css` to the files touched. Add after the hamburger section:

```css
/* ==========================================================================
   THEME TOGGLE
   Dark/light mode switch button in header.
   ========================================================================== */

.theme-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  padding: var(--spacing-xs);
  cursor: pointer;
  color: var(--color-text-secondary);
  transition: color var(--transition-fast), border-color var(--transition-fast);
}

.theme-toggle:hover {
  color: var(--color-link);
  border-color: var(--color-border-strong);
}

.theme-toggle svg {
  display: block;
}
```

IMPORTANT: The sun icon (`theme-icon-light`) starts with `display: block` and moon (`theme-icon-dark`) starts with `display: none` in the HTML. The JS immediately runs `updateIcon()` on load to set the correct icon based on the effective theme. If the user is in dark mode (via FOUC script or OS preference), the JS will show the sun icon; if in light mode, the moon icon. The initial HTML default (sun visible) matches the most common case (light mode visitors).
  </action>
  <verify>Run `npx @11ty/eleventy --input=src --output=_site 2>&1 | tail -5` to confirm site builds. Check that `_site/js/theme-toggle.js` exists. Grep base.njk for `skip-link`, `main-content`, `data-theme`, and `theme-toggle`. Grep header.njk for `theme-toggle`.</verify>
  <done>Dark mode toggle button appears in header. FOUC prevention script runs before stylesheets. Skip-to-content link is the first focusable element in the body. Theme toggle JS persists preference to localStorage and toggles data-theme attribute.</done>
</task>

<task type="auto">
  <name>Task 2: Add reading time Eleventy filter and display it in article template</name>
  <files>eleventy.config.js, src/_includes/layouts/article.njk</files>
  <action>
**In eleventy.config.js**, add a `readingTime` filter. Place it after the existing shortcode definitions (after the `marginnote` shortcode block) and before the `return` statement:

```javascript
// Reading time filter: strips HTML, counts words, returns "N min read"
eleventyConfig.addFilter("readingTime", function(content) {
  if (!content) return "";
  var text = content.replace(/<[^>]*>/g, " ");
  text = text.replace(/\s+/g, " ").trim();
  var words = text.split(" ").filter(function(w) { return w.length > 0; }).length;
  var minutes = Math.ceil(words / 230);
  return minutes + " min read";
});
```

The 230 WPM rate is appropriate for technical/mathematical content (slightly below the 238 standard for general prose).

**In src/_includes/layouts/article.njk**, add the reading time display in the `<header class="article-header">` section. Place it after the description paragraph and before the prerequisites div. Add it as a `<div class="article-meta">`:

```njk
<div class="article-meta">
  {{ content | readingTime }}
</div>
```

This should go right after the `{% endif %}` that closes the description block and right before the `{% if prerequisites and prerequisites.length %}` block. The `.article-meta` class already exists in components.css with appropriate styling (small font, muted color, top margin).
  </action>
  <verify>Run `npx @11ty/eleventy --input=src --output=_site 2>&1 | tail -5` to confirm site builds. Check a built article page (e.g., `grep 'min read' _site/topics/attention-mechanism/index.html`) to confirm reading time appears.</verify>
  <done>Every article page displays a reading time estimate (e.g., "12 min read") in the article header area between the description and prerequisites.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete dark mode system with:
    1. CSS custom property dark theme (auto-detects OS preference via prefers-color-scheme)
    2. Manual toggle button in header (persists to localStorage)
    3. FOUC prevention (no white flash when loading with dark preference)
    4. Prism code blocks adapt to dark mode via CSS variables
    5. All components (badges, buttons, sidebar, hero, selection) adapt
    6. Skip-to-content link (first focusable element)
    7. Enhanced dual-color focus indicators
    8. Reading time on every article
  </what-built>
  <how-to-verify>
    1. Start dev server: `npx @11ty/eleventy --serve --input=src`
    2. Open http://localhost:8080/learn-mech-interp/ in your browser
    3. **Dark mode toggle:** Click the moon/sun icon in the header. The entire page should switch between light and dark themes.
    4. **FOUC test:** With dark mode active, reload the page. It should load directly in dark mode with no flash of white.
    5. **OS auto-detection:** Clear localStorage (`localStorage.removeItem('theme')` in console), then toggle your OS dark mode setting. The site should follow.
    6. **Code blocks:** Visit any article with code (e.g., /topics/attention-mechanism/) and verify code syntax colors are readable in dark mode.
    7. **KaTeX math:** Verify math equations display with light text on dark background (should inherit text color automatically).
    8. **Difficulty badges:** Check that foundational/intermediate/advanced badges have appropriate dark-mode colors.
    9. **Skip-to-content:** Press Tab on any page. A "Skip to content" link should appear at the top. Pressing Enter should jump to the main content.
    10. **Focus indicators:** Tab through links and buttons. Focus rings should be visible in both light and dark mode.
    11. **Reading time:** Check any article. A "N min read" estimate should appear in the article header.
    12. **Mobile:** Resize the browser to mobile width. Toggle hamburger menu, verify sidebar looks correct in dark mode. Verify toggle button is accessible.
  </how-to-verify>
  <resume-signal>Type "approved" if everything looks good, or describe any issues with specific components.</resume-signal>
</task>

</tasks>

<verification>
1. Full Eleventy build succeeds: `npx @11ty/eleventy --input=src --output=_site`
2. Dark mode toggle exists in built HTML: `grep 'theme-toggle' _site/index.html`
3. FOUC script in head: `grep 'localStorage.*theme' _site/index.html`
4. Skip link present: `grep 'skip-link' _site/index.html`
5. Main has ID: `grep 'id="main-content"' _site/index.html`
6. Reading time in articles: `grep 'min read' _site/topics/attention-mechanism/index.html`
7. Theme toggle JS deployed: `test -f _site/js/theme-toggle.js`
</verification>

<success_criteria>
- Dark mode activates via OS preference (prefers-color-scheme) and can be toggled manually via header button
- No FOUC when loading with stored dark preference
- Skip-to-content link appears on Tab and navigates to main content
- Focus indicators visible in both light and dark mode
- Reading time displayed on every article page
- KaTeX, code blocks, and diagrams display correctly in dark mode
- All site components (badges, buttons, sidebar, hero) adapt to dark mode
- Site builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-accessibility/07-02-SUMMARY.md`
</output>
