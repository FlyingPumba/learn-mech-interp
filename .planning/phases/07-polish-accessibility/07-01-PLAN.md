---
phase: 07-polish-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/css/variables.css
  - src/css/prism-theme.css
  - src/css/base.css
  - src/css/components.css
  - src/css/katex-overrides.css
autonomous: true

must_haves:
  truths:
    - "Dark mode colors are defined as CSS custom properties that override light theme values under both @media (prefers-color-scheme: dark) and [data-theme='dark']"
    - "Prism syntax highlighting tokens use CSS custom properties instead of hardcoded hex/rgba values, so code blocks adapt to dark mode"
    - "Difficulty badges, selection color, header/hero gradients, sidebar box-shadow, and button hover backgrounds all adapt to dark mode via variables"
    - "Focus indicators use a dual-color approach visible against both light and dark backgrounds"
  artifacts:
    - path: "src/css/variables.css"
      provides: "Dark theme variable overrides in both media query and data-theme blocks, plus Prism token color variables"
      contains: "[data-theme=\"dark\"]"
    - path: "src/css/prism-theme.css"
      provides: "Token colors referencing CSS custom properties instead of hardcoded values"
      contains: "var(--prism-"
    - path: "src/css/base.css"
      provides: "Selection color using a CSS custom property, enhanced focus-visible with box-shadow"
      contains: "var(--color-selection)"
    - path: "src/css/components.css"
      provides: "Difficulty badge colors as CSS custom properties, sidebar box-shadow variable, button hover backgrounds using variables"
      contains: "var(--color-badge-"
  key_links:
    - from: "src/css/variables.css"
      to: "src/css/prism-theme.css"
      via: "Prism token variables defined in :root, overridden in dark blocks"
      pattern: "--prism-keyword"
    - from: "src/css/variables.css"
      to: "src/css/components.css"
      via: "Badge and selection variables defined in :root, overridden in dark blocks"
      pattern: "--color-badge-"
---

<objective>
Create the complete dark mode color system by adding dark theme variable overrides to variables.css, migrating Prism token colors from hardcoded values to CSS custom properties, and converting all remaining hardcoded colors (difficulty badges, selection, gradients, sidebar shadow, button hover backgrounds) to variables that adapt in dark mode. Also enhance focus indicators for both-theme visibility.

Purpose: This plan establishes the CSS foundation that the toggle and template wiring (Plan 02) will activate. Without these variable overrides, toggling data-theme would have no visual effect.
Output: All CSS files updated with dark-mode-ready variables. Site still looks identical in light mode but is structurally ready for dark mode activation.
</objective>

<execution_context>
@/Users/ivan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ivan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-accessibility/07-RESEARCH.md

Key existing files:
@src/css/variables.css
@src/css/prism-theme.css
@src/css/base.css
@src/css/components.css
@src/css/katex-overrides.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dark theme variables and Prism token variables to variables.css</name>
  <files>src/css/variables.css</files>
  <action>
Add Prism token color variables to the existing `:root` block (after the transitions section):

```css
/* Colors - Syntax Highlighting (Prism) */
--prism-comment: rgba(0, 0, 0, 0.4);
--prism-punctuation: rgba(0, 0, 0, 0.6);
--prism-keyword: #004276;
--prism-string: #22863a;
--prism-number: #6f42c1;
--prism-function: #005cc5;
--prism-operator: rgba(0, 0, 0, 0.6);
--prism-class: #005cc5;
--prism-attr-name: #6f42c1;
--prism-deleted: #b31d28;
--prism-deleted-bg: rgba(179, 29, 40, 0.08);
--prism-inserted: #22863a;
--prism-inserted-bg: rgba(34, 134, 58, 0.08);
--prism-highlight-bg: rgba(0, 66, 118, 0.06);

/* Colors - Selection */
--color-selection: rgba(0, 66, 118, 0.2);

/* Colors - Difficulty Badges */
--color-badge-foundational-bg: #e8f5e9;
--color-badge-foundational-text: #2e7d32;
--color-badge-intermediate-bg: #fff3e0;
--color-badge-intermediate-text: #e65100;
--color-badge-advanced-bg: #fce4ec;
--color-badge-advanced-text: #c62828;

/* Colors - Decorative */
--color-header-gradient: rgba(0, 66, 118, 0.02);
--color-hero-gradient-start: rgba(0, 66, 118, 0.03);
--color-hero-gradient-end: rgba(0, 66, 118, 0.01);
--color-sidebar-shadow: rgba(0, 0, 0, 0.1);
--color-btn-secondary-hover-bg: rgba(0, 66, 118, 0.04);
--color-sidebar-hover-bg: rgba(0, 66, 118, 0.04);
--color-sidebar-active-bg: rgba(0, 66, 118, 0.08);
--color-feature-card-shadow: rgba(0, 0, 0, 0.04);
```

Then add TWO dark theme blocks AFTER the `:root` block:

1. `@media (prefers-color-scheme: dark) { :root:not([data-theme="light"]) { ... } }` for auto-detection
2. `[data-theme="dark"] { ... }` for manual override

Both blocks contain the SAME variable overrides. The dark values are:

```css
/* Text */
--color-text: rgba(255, 255, 255, 0.87);
--color-text-secondary: rgba(255, 255, 255, 0.6);
--color-text-muted: rgba(255, 255, 255, 0.4);

/* Background */
--color-background: #1a1a2e;
--color-background-subtle: rgba(255, 255, 255, 0.04);
--color-background-code: rgba(255, 255, 255, 0.08);

/* Interactive */
--color-link: #6db3f2;
--color-link-hover: #8ec5f5;
--color-link-visited: #a0aec0;

/* Borders */
--color-border: rgba(255, 255, 255, 0.1);
--color-border-strong: rgba(255, 255, 255, 0.2);

/* Prism (dark palette) */
--prism-comment: rgba(255, 255, 255, 0.4);
--prism-punctuation: rgba(255, 255, 255, 0.5);
--prism-keyword: #7ec8e3;
--prism-string: #98c379;
--prism-number: #d19a66;
--prism-function: #dcdcaa;
--prism-operator: rgba(255, 255, 255, 0.5);
--prism-class: #4ec9b0;
--prism-attr-name: #c678dd;
--prism-deleted: #e06c75;
--prism-deleted-bg: rgba(224, 108, 117, 0.15);
--prism-inserted: #98c379;
--prism-inserted-bg: rgba(152, 195, 121, 0.15);
--prism-highlight-bg: rgba(109, 179, 242, 0.1);

/* Selection */
--color-selection: rgba(109, 179, 242, 0.3);

/* Difficulty Badges (darker, more saturated for dark backgrounds) */
--color-badge-foundational-bg: rgba(46, 125, 50, 0.2);
--color-badge-foundational-text: #81c784;
--color-badge-intermediate-bg: rgba(230, 81, 0, 0.2);
--color-badge-intermediate-text: #ffb74d;
--color-badge-advanced-bg: rgba(198, 40, 40, 0.2);
--color-badge-advanced-text: #ef9a9a;

/* Decorative */
--color-header-gradient: rgba(109, 179, 242, 0.03);
--color-hero-gradient-start: rgba(109, 179, 242, 0.04);
--color-hero-gradient-end: rgba(109, 179, 242, 0.01);
--color-sidebar-shadow: rgba(0, 0, 0, 0.3);
--color-btn-secondary-hover-bg: rgba(109, 179, 242, 0.08);
--color-sidebar-hover-bg: rgba(109, 179, 242, 0.06);
--color-sidebar-active-bg: rgba(109, 179, 242, 0.12);
--color-feature-card-shadow: rgba(0, 0, 0, 0.2);
```

IMPORTANT: The two dark blocks (media query and data-theme) have IDENTICAL variable values. The media query block uses `:root:not([data-theme="light"])` to yield to explicit user preference.
  </action>
  <verify>Run `npx @11ty/eleventy --input=src --output=_site 2>&1 | tail -5` to confirm site still builds. Grep variables.css for `[data-theme="dark"]` and `prefers-color-scheme` to confirm both blocks exist.</verify>
  <done>variables.css has light theme Prism/badge/selection/decorative variables in :root, and two dark theme override blocks (auto-detection + manual) with complete variable coverage.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate Prism theme to variables and fix all hardcoded colors across CSS files</name>
  <files>src/css/prism-theme.css, src/css/base.css, src/css/components.css</files>
  <action>
**prism-theme.css:** Replace every hardcoded color with its CSS custom property equivalent:
- `.token.comment` etc.: `color: rgba(0, 0, 0, 0.4)` -> `color: var(--prism-comment)`
- `.token.punctuation`: `color: rgba(0, 0, 0, 0.6)` -> `color: var(--prism-punctuation)`
- `.token.keyword` etc.: `color: #004276` -> `color: var(--prism-keyword)`
- `.token.string` etc.: `color: #22863a` -> `color: var(--prism-string)`
- `.token.number`: `color: #6f42c1` -> `color: var(--prism-number)`
- `.token.function`: `color: #005cc5` -> `color: var(--prism-function)`
- `.token.operator` etc.: `color: rgba(0, 0, 0, 0.6)` -> `color: var(--prism-operator)`
- `.token.class-name` etc.: `color: #005cc5` -> `color: var(--prism-class)`
- `.token.attr-name`: `color: #6f42c1` -> `color: var(--prism-attr-name)`
- `.token.decorator` etc.: `color: #6f42c1` -> `color: var(--prism-attr-name)` (same variable, decorators share the purple)
- `.token.deleted`: `color: #b31d28` -> `color: var(--prism-deleted)`, `background: rgba(179, 29, 40, 0.08)` -> `background: var(--prism-deleted-bg)`
- `.token.inserted`: `color: #22863a` -> `color: var(--prism-inserted)`, `background: rgba(34, 134, 58, 0.08)` -> `background: var(--prism-inserted-bg)`
- `.highlight-line`: `background: rgba(0, 66, 118, 0.06)` -> `background: var(--prism-highlight-bg)`

**base.css:**
- `::selection` block: `background: rgba(0, 66, 118, 0.2)` -> `background: var(--color-selection)`
- `:focus-visible` block: enhance to dual-color approach:
  ```css
  :focus-visible {
    outline: 2px solid var(--color-link);
    outline-offset: 2px;
    box-shadow: 0 0 0 4px var(--color-background);
  }
  ```
  The `box-shadow` using `--color-background` creates a contrasting halo that works in both themes.

**components.css:**
- `.site-header` background: `rgba(0, 66, 118, 0.02)` -> `var(--color-header-gradient)`
  Full line: `background: linear-gradient(180deg, var(--color-header-gradient) 0%, transparent 100%);`
- `.hero` background: replace literal rgba values with gradient variables
  `background: linear-gradient(180deg, var(--color-hero-gradient-start) 0%, var(--color-hero-gradient-end) 50%, transparent 100%);`
- `.difficulty-foundational`: `background: #e8f5e9` -> `background: var(--color-badge-foundational-bg)`, `color: #2e7d32` -> `color: var(--color-badge-foundational-text)`
- `.difficulty-intermediate`: `background: #fff3e0` -> `background: var(--color-badge-intermediate-bg)`, `color: #e65100` -> `color: var(--color-badge-intermediate-text)`
- `.difficulty-advanced`: `background: #fce4ec` -> `background: var(--color-badge-advanced-bg)`, `color: #c62828` -> `color: var(--color-badge-advanced-text)`
- `.sidebar.sidebar-open` box-shadow: `rgba(0, 0, 0, 0.1)` -> `var(--color-sidebar-shadow)`
  `box-shadow: 4px 0 12px var(--color-sidebar-shadow);`
- `.btn-secondary:hover` background: `rgba(0, 66, 118, 0.04)` -> `var(--color-btn-secondary-hover-bg)`
- `.sidebar-topics a:hover` background: `rgba(0, 66, 118, 0.04)` -> `var(--color-sidebar-hover-bg)`
- `.sidebar-topics a.sidebar-active` / `a[aria-current="page"]` background: `rgba(0, 66, 118, 0.08)` -> `var(--color-sidebar-active-bg)`
- `.feature-card:hover` box-shadow: `rgba(0, 0, 0, 0.04)` -> `var(--color-feature-card-shadow)`

Do NOT change values that already use `var()` references (most of components.css already does). Only change hardcoded hex/rgba values that appear in the research findings.
  </action>
  <verify>Run `npx @11ty/eleventy --input=src --output=_site 2>&1 | tail -5` to confirm site builds. Grep prism-theme.css for any remaining hardcoded `#` hex colors (should find none except in comments). Grep components.css for `#e8f5e9`, `#fff3e0`, `#fce4ec` (should find none).</verify>
  <done>All Prism token colors use CSS custom properties. All hardcoded colors in base.css and components.css (selection, badges, gradients, shadow, hover backgrounds) use CSS custom properties that will adapt when dark theme variables are active. Focus indicators use dual-color approach.</done>
</task>

</tasks>

<verification>
1. Run full Eleventy build: `npx @11ty/eleventy --input=src --output=_site` succeeds
2. Grep for hardcoded badge colors: `grep -r '#e8f5e9\|#fff3e0\|#fce4ec\|#2e7d32\|#e65100\|#c62828' src/css/` returns no results
3. Grep for Prism variables in use: `grep 'var(--prism-' src/css/prism-theme.css` returns 10+ matches
4. Confirm dark theme blocks exist: `grep -c 'data-theme.*dark' src/css/variables.css` returns at least 1
5. Confirm media query block exists: `grep 'prefers-color-scheme.*dark' src/css/variables.css` returns a match
6. Site looks identical in light mode (no visual regression since only variable indirection was added)
</verification>

<success_criteria>
- variables.css contains Prism token variables, badge variables, selection variable, and decorative variables in :root
- variables.css contains two dark theme override blocks (media query + data-theme) with complete variable coverage
- prism-theme.css uses var(--prism-*) for all token colors (zero hardcoded hex/rgba color values in token rules)
- base.css uses var(--color-selection) for ::selection and has dual-color focus-visible
- components.css uses variables for badge colors, gradients, shadows, and hover backgrounds
- Site builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-accessibility/07-01-SUMMARY.md`
</output>
